---
# ============================================
# ğŸ–¥ï¸ Setup Ubuntu 24.04 Base Server
# ============================================
# Ethereum Validator Node ìš´ì˜ì„ ìœ„í•œ ê¸°ë³¸ ì„œë²„ ì„¤ì •
#
# í¬í•¨ êµ¬ì„±:
#   1. ğŸ“¦ Packages - ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
#   2. ğŸ”’ Security - SSH, UFW, Fail2Ban, ìë™ ì—…ë°ì´íŠ¸
#   3. âš¡ Tuning - ì»¤ë„/ë„¤íŠ¸ì›Œí¬/ìŠ¤í† ë¦¬ì§€ ìµœì í™”
#   4. ğŸ’¾ Storage - /data ë§ˆìš´íŠ¸, LVM ì„¤ì •
#   5. ğŸ‘¤ Users - ì´ë”ë¦¬ì›€ ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±
#   6. ğŸ³ Docker - Docker Engine ë° Compose ì„¤ì¹˜
#   7. â° Chrony - ì‹œê°„ ë™ê¸°í™”
#   8. ğŸ–¥ï¸ Shell - ì—ë””í„° ë° í”„ë¡¬í”„íŠ¸ ì„¤ì •
#   9. ğŸ¥ Healthcheck - ì„œë²„ ìƒíƒœ ëª¨ë‹ˆí„°ë§
#
# ì‚¬ìš©ë²•:
#   make ap-setup-servers
#   # ë˜ëŠ” LVM ì„¤ì • í¬í•¨
#   make ap-setup-servers ARGS="--tags lvm_setup"
# ============================================

- name: Setup Ubuntu 24.04 Base Server (Validator Optimized)
  hosts: home_servers
  become: true
  vars_files:
    - vars/secrets.yml
  vars:
    # --- Network Selection ---
    _enabled_networks: "{{ enabled_networks | default(['mainnet']) }}"
    admin_user_ssh_key: "{{ lookup('file', admin_user_ssh_key_path | default('~/.ssh/id_rsa.pub')) }}"

    # --- Docker ---
    docker_compose_plugin_dir: /usr/local/lib/docker/cli-plugins
    docker_compose_url: 'https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64'

    # --- Swap (geerlingguy.swap role) ---
    swap_file_size_mb: 8192
    swap_file_path: /swap.img
    swap_swappiness: 10

  # ============================================
  # Pre-Tasks: í˜¸ìŠ¤íŠ¸ ì •ë³´ ìˆ˜ì§‘
  # ============================================
  pre_tasks:
    - name: Group hosts by cloud provider
      ansible.builtin.group_by:
        key: "group_{{ cloud_provider | default('local') }}"
      changed_when: false

    - name: Show host configuration
      ansible.builtin.debug:
        msg:
          - 'cloud_provider: {{ cloud_provider }}'
          - 'host_type: {{ host_type }}'
          - 'enabled_networks: {{ _enabled_networks }}'

  # ============================================
  # Tasks: ëª¨ë“ˆí™”ëœ íƒœìŠ¤í¬ íŒŒì¼ include
  # ============================================
  tasks:
    # --- 1. ğŸ“¦ Packages ---
    - name: 'ğŸ“¦ Install Base Packages'
      ansible.builtin.include_tasks:
        file: tasks/setup-packages.yml
      tags: packages

    # --- 2. ğŸ”’ Security ---
    - name: 'ğŸ”’ Configure Security (SSH, UFW, Fail2Ban)'
      ansible.builtin.include_tasks:
        file: tasks/setup-security.yml
      tags: security

    # --- 3. âš¡ Tuning ---
    - name: 'âš¡ Apply System Performance Tuning'
      ansible.builtin.include_tasks:
        file: tasks/setup-tuning.yml
      tags: tuning

    # --- 3.5. Swap Role ---
    - name: 'ğŸ’¾ Run swap role (if not VC)'
      ansible.builtin.include_role:
        name: geerlingguy.swap
      when: host_type != 'vc'
      tags: swap

    # --- 4. ğŸ’¾ Storage ---
    - name: 'ğŸ’¾ Configure Storage (/data, LVM)'
      ansible.builtin.include_tasks:
        file: tasks/setup-storage.yml
      tags: storage

    # --- 5. ğŸ‘¤ Users ---
    - name: 'ğŸ‘¤ Create Ethereum Service Users'
      ansible.builtin.include_tasks:
        file: tasks/create-eth-users.yml
      loop: '{{ _enabled_networks }}'
      loop_control:
        loop_var: network_item
      tags: users

    # --- 6. ğŸ³ Docker ---
    - name: 'ğŸ³ Setup Docker and Docker Compose'
      ansible.builtin.include_tasks:
        file: tasks/setup-docker.yml
      when: host_type != 'vc'
      tags: docker

    # --- 7. â° Chrony ---
    - name: 'â° Configure Time Synchronization (Chrony)'
      ansible.builtin.include_tasks:
        file: tasks/setup-chrony.yml
      tags: chrony

    # --- 8. ğŸ–¥ï¸ Shell ---
    - name: 'ğŸ–¥ï¸ Configure Shell (vim, prompt)'
      ansible.builtin.include_tasks:
        file: tasks/setup-shell.yml
      tags: shell

    # --- 9. ğŸ¥ Healthcheck ---
    - name: 'ğŸ¥ Configure Healthcheck Cron Jobs'
      ansible.builtin.include_tasks:
        file: tasks/setup-healthcheck.yml
      when: healthcheck_webhook_url is defined
      tags: healthcheck

  # ============================================
  # Handlers
  # ============================================
  handlers:
    - name: Restart sshd
      ansible.builtin.systemd_service:
        name: sshd
        state: restarted

    - name: Restart fail2ban
      ansible.builtin.systemd_service:
        name: fail2ban
        state: restarted

    - name: Update grub
      ansible.builtin.command: update-grub

---
- name: Setup Ethereum Node (EL+CL)
  hosts: ethereum_nodes
  gather_facts: true
  vars:
    # workspace configuration
    custom_prompt_name: '{{ inventory_hostname }}'
    user_workspace_subdirs:
      - cmd
      - config
      - env
      - lib
      - bin
      - bin/lighthouse
      - bin/mevboost
    # network_typeÏùÄ Ïù∏Î≤§ÌÜ†Î¶¨ÏóêÏÑú 'mainnet' ÎòêÎäî 'testnet'ÏúºÎ°ú Ï†ïÏùò
    # networkÎäî Ïã§Ï†ú ÎÑ§Ìä∏ÏõåÌÅ¨Î™Ö (Ïòà: mainnet, hoodi)
    network_type: "{{ 'testnet' if network in ['hoodi', 'holesky', 'sepolia'] else 'mainnet' }}"
  pre_tasks:
    - name: Load network-specific variables (mainnet/testnet)
      ansible.builtin.include_vars:
        file: 'vars/{{ network_type }}.yml'

    - name: Set data directory paths based on network type
      ansible.builtin.set_fact:
        cl_datadir: '{{ eth_cl_dir }}'
        jwt_secret_path: '{{ eth_el_dir }}/jwt.hex'

    - name: Display all variables/facts for the current host
      ansible.builtin.debug:
        msg:
          - 'network: {{ network }}'
          - 'network_type: {{ network_type }}'
          - 'el version: {{ el_version }}'
          - 'cl version: {{ cl_version }}'
          - 'mev version: {{ mev_version }}'
          - 'min bid: {{ min_bid }}'
          - 'eth_node_user: {{ eth_node_user }}'
          - 'data dirs: {{ eth_el_dir }}, {{ eth_cl_dir }}'

    - name: üìÇ Ensure data directories exist (with correct ownership)
      become: true
      ansible.builtin.file:
        path: '{{ item.path }}'
        state: directory
        owner: '{{ item.owner }}'
        group: '{{ item.group }}'
        mode: '{{ item.mode }}'
      loop:
        - { path: '{{ eth_base_dir }}', owner: root, group: root, mode: '0755' }
        - path: '{{ eth_el_dir }}'
          owner: '{{ eth_node_user }}'
          group: '{{ eth_node_user }}'
          mode: '0750'
        - path: '{{ eth_cl_dir }}'
          owner: '{{ eth_node_user }}'
          group: '{{ eth_node_user }}'
          mode: '0750'
        - path: '{{ eth_vc_dir }}'
          owner: '{{ eth_vc_user }}'
          group: '{{ eth_vc_user }}'
          mode: '0750'
  tasks:
    - name: üóÇÔ∏è Create workspace directories
      ansible.builtin.file:
        path: '{{ ansible_facts.user_dir }}/workspace/{{ item }}'
        state: directory
        mode: '0755'
      loop: '{{ user_workspace_subdirs }}'

    - name: Set custom shell prompt in .profile
      ansible.builtin.lineinfile:
        path: '~/.profile'
        regexp: '^export PS1=.*# ANSIBLE_PROMPT_MARKER$'
        line: 'export PS1="\[\033[01;32m\]{{ custom_prompt_name }}\[\033[00m\]:\[\033[01;34m\]\\w\[\033[00m\]\\$ " # ANSIBLE_PROMPT_MARKER'
        state: present
        create: true
        mode: '0644'
        insertafter: EOF
        backup: true

    - name: Ensure all .sh scripts and sourced by .profile
      ansible.builtin.blockinfile:
        path: '~/.profile'
        create: true
        mode: '0644'
        marker: '# {mark} ANSIBLE MANAGED BLOCK FOR WORKSPACE ENV SCRIPTS'
        block: |
          if [ -d "{{ ansible_facts.user_dir }}/env" ]; then
            for env_file_to_source in "{{ ansible_facts.user_dir }}/env"/*.env; do
              if [ -f "$env_file_to_source" ] && [ -r "$env_file_to_source" ]; then
                . "$env_file_to_source"
              fi
            done
            unset env_file_to_source
          fi

    - name: Add workspace bin directories to PATH in .profile
      ansible.builtin.lineinfile:
        path: '~/.profile'
        regexp: '^export PATH=.*# ANSIBLE_MANAGED_PATH$'
        line: 'export PATH="$HOME/workspace/bin/lighthouse:$HOME/workspace/bin/nethermind:$PATH" # ANSIBLE_MANAGED_PATH'
        state: present
        create: true
        mode: '0644'
        insertafter: EOF
        backup: true

    # --- JWT Secret Generation (shared between EL and CL) ---
    - name: Check if JWT secret file already exists
      ansible.builtin.stat:
        path: '{{ jwt_secret_path }}'
      register: jwt_file_stat

    - name: Generate JWT secret in memory (if not exists)
      ansible.builtin.command: openssl rand -hex 32
      register: jwt_secret
      when: not jwt_file_stat.stat.exists
      changed_when: false

    - name: Write JWT secret to file (if not exists)
      ansible.builtin.copy:
        content: '{{ jwt_secret.stdout }}'
        dest: '{{ jwt_secret_path }}'
        owner: '{{ eth_node_user }}'
        group: '{{ eth_node_user }}'
        mode: '0600'
      when: not jwt_file_stat.stat.exists

    # --- Include separated installation tasks ---
    - name: Install Execution Layer (EL) client
      vars:
        el_data_dir: '{{ eth_el_dir }}'
        el_bin_dir: '{{ ansible_facts.user_dir }}/workspace/bin/nethermind'
        el_template_source: '../templates/el.service.j2'
        workspace_lib_dir: '{{ ansible_facts.user_dir }}/workspace/lib'
        cmd_template_source: '../templates/cmd.sh.j2'
        service_name: 'el_{{ network }}'
      ansible.builtin.include_tasks: tasks/install_el.yml

    - name: Install Consensus Layer (CL) client
      vars:
        cl_data_dir: '{{ eth_cl_dir }}'
        cl_bin_dir: '{{ ansible_facts.user_dir }}/workspace/bin/lighthouse'
        cl_template_source: '../templates/cl.service.j2'
        workspace_lib_dir: '{{ ansible_facts.user_dir }}/workspace/lib'
        cmd_template_source: '../templates/cmd.sh.j2'
        service_name: 'cl_{{ network }}'
      ansible.builtin.include_tasks: tasks/install_cl.yml

    - name: Install MEV-Boost
      vars:
        mevboost_bin_dir: '{{ ansible_facts.user_dir }}/workspace/bin/mevboost'
        mevboost_template_source: '../templates/mevboost.service.j2'
        workspace_lib_dir: '{{ ansible_facts.user_dir }}/workspace/lib'
        username: '{{ ansible_facts.user_id }}'
      ansible.builtin.include_tasks: tasks/install_mevboost.yml

    - name: üöÄ Ensure Ethereum services are enabled and started
      become: true
      ansible.builtin.systemd_service:
        name: '{{ item }}'
        enabled: true
        state: started
      loop:
        - 'el_{{ network }}'
        - 'cl_{{ network }}'
        - 'mevboost_{{ network }}'

  post_tasks:
    - name: Get Nethermind version
      ansible.builtin.command: '{{ ansible_facts.user_dir }}/workspace/bin/nethermind/Nethermind.Runner --version'
      register: nethermind_version_recap
      changed_when: false

    - name: Get Lighthouse version
      ansible.builtin.command: '{{ ansible_facts.user_dir }}/workspace/bin/lighthouse/lighthouse --version'
      register: lighthouse_version_recap
      changed_when: false

    - name: Get MEV-Boost version
      ansible.builtin.command: '{{ ansible_facts.user_dir }}/workspace/bin/mevboost/mev-boost -version'
      register: mevboost_version_recap
      changed_when: false

    - name: üìú Version Recap
      ansible.builtin.debug:
        msg:
          - '---------------------------------------------------'
          - 'Execution Layer (Nethermind):'
          - "{{ nethermind_version_recap.stdout_lines | default(['Unknown']) | join('\n') }}"
          - '---------------------------------------------------'
          - 'Consensus Layer (Lighthouse):'
          - "{{ lighthouse_version_recap.stdout_lines | default(['Unknown']) | join('\n') }}"
          - '---------------------------------------------------'
          - 'MEV-Boost:'
          - "{{ mevboost_version_recap.stdout_lines | default(['Unknown']) | join('\n') }}"
          - '---------------------------------------------------'

  # --- Handlers ---
  handlers:
    - name: Reload systemd
      become: true
      ansible.builtin.systemd_service:
        daemon_reload: true

    - name: Restart EL service
      become: true
      ansible.builtin.systemd_service:
        name: 'el_{{ network }}'
        state: restarted

    - name: Restart CL service
      become: true
      ansible.builtin.systemd_service:
        name: 'cl_{{ network }}'
        state: restarted

    - name: Restart MEV-Boost service
      become: true
      ansible.builtin.systemd_service:
        name: 'mevboost_{{ network }}'
        state: restarted

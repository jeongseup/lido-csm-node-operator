#!/bin/bash

# --- 스크립트 설정 ---
# set -e: 명령어가 실패하면 즉시 스크립트를 중지합니다.
# set -u: 정의되지 않은 변수를 사용하면 에러를 발생시킵니다.
# set -o pipefail: 파이프(|)로 연결된 명령어 중 하나라도 실패하면 전체를 실패로 간주합니다.
set -eu -o pipefail

# [설정] 관리할 systemd 서비스 이름을 여기에 고정합니다.
readonly TARGET_SERVICE="{{ service_name }}.service"

# --- 1. 도움말 함수 ---
print_usage() {
    echo "오류: 액션(action)이 필요합니다."
    echo ""
    echo "사용법: $0 <action>"
    echo "액션 목록:"
    echo "  start    - 서비스 시작 및 로그 표시 (sudo 필요)"
    echo "  stop     - 서비스 중지 (sudo 필요)"
    echo "  restart  - 서비스 재시작 (sudo 필요)"
    echo "  status   - 서비스 상태 확인"
    echo "  enable   - 부팅 시 자동 시작 활성화 (sudo 필요)"
    echo "  disable  - 부팅 시 자동 시작 비활성화 (sudo 필요)"
    echo "  log      - 실시간 로그 보기 (Ctrl+C로 종료)"
    echo "  edit     - 서비스 설정 파일 편집 (sudo 필요)"
}

# --- 2. 파라미터 확인 ---
# $1 (첫 번째 파라미터)가 비어 있는지 확인합니다.
if [[ -z "${1-}" ]]; then
    print_usage
    exit 1
fi

readonly ACTION=$1

# --- 3. 액션 실행 ---
case "$ACTION" in
    start)
        echo "--- '${ACTION}' 실행: ${TARGET_SERVICE} (sudo 필요) ---"
        sudo systemctl "$ACTION" "$TARGET_SERVICE"
        echo "--- 완료 ---"
        echo "--- 서비스 시작됨, 실시간 로그를 표시합니다 (Ctrl+C로 종료) ---"
        # 'start' 실행 후 바로 'log' 기능 실행
        journalctl -f -u "$TARGET_SERVICE" -n 50 --no-pager
        ;;

    stop|restart|enable|disable)
        echo "--- '${ACTION}' 실행: ${TARGET_SERVICE} (sudo 필요) ---"
        sudo systemctl "$ACTION" "$TARGET_SERVICE"
        echo "--- 완료 ---"
        ;;

    status)
        echo "--- 상태 확인: ${TARGET_SERVICE} ---"
        # 'status'는 서비스가 중지(failed) 상태일 때 0이 아닌 코드를 반환하므로,
        # '|| true'를 붙여 스크립트가 'set -e'로 인해 중단되는 것을 방지합니다.
        systemctl status "$TARGET_SERVICE" || true
        ;;

    log)
        echo "--- 실시간 로그: ${TARGET_SERVICE} (Ctrl+C로 종료) ---"
        journalctl -fu "$TARGET_SERVICE"
        ;;

    edit)
        echo "--- 서비스 파일 편집: ${TARGET_SERVICE} (sudo 필요) ---"
        # 'systemctl edit'는 서비스 파일을 안전하게 편집하는 가장 좋은 방법입니다.
        # --full 플래그는 전체 파일을 편집하도록 하며, 저장 시 자동으로 systemd 데몬을 리로드합니다.
        sudo systemctl edit --full "$TARGET_SERVICE"
        echo "--- 서비스 파일이 업데이트되었습니다. ---"
        ;;

    *)
        echo "알 수 없는 액션입니다: $ACTION"
        print_usage
        exit 1
        ;;
esac
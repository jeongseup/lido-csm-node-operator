---
# ============================================
# üóëÔ∏è Node Teardown Playbook
# ============================================
# Ethereum Node (EL/CL/MEV-Boost) Î¶¨ÏÜåÏä§Î•º Ï†ïÎ¶¨Ìï©ÎãàÎã§.
# - Phase 1: Node Ïú†Ï†ÄÎ°ú workspace ÌôïÏù∏
# - Phase 2: ÏÑúÎ≤Ñ(root)Î°ú ÏÑúÎπÑÏä§/Îç∞Ïù¥ÌÑ∞/Ïú†Ï†Ä ÏÇ≠Ï†ú
#
# ÏÇ¨Ïö©Î≤ï:
#   ansible-playbook playbooks/teardown-node.yml \
#     -e "target_node=p-home-bucheon-node-ethereum-testnet" \
#     -e "server_host=p-home-bucheon-server-root" \
#     -e "delete_data=true" \
#     -e "delete_user=true"
#
# ÌïÑÏàò Î≥ÄÏàò:
#   - target_node: Ï†ïÎ¶¨Ìï† Node Ìò∏Ïä§Ìä∏ (Ïù∏Î≤§ÌÜ†Î¶¨Ïóê Ï†ïÏùòÎêú Ìò∏Ïä§Ìä∏)
#   - server_host: ÏÑúÎ≤Ñ Ìò∏Ïä§Ìä∏ (root Ï†ëÏÜçÏö©, Ïú†Ï†Ä ÏÇ≠Ï†ú Ïãú ÌïÑÏöî)
#
# ÏÑ†ÌÉù Î≥ÄÏàò:
#   - delete_data: Îç∞Ïù¥ÌÑ∞ ÎîîÎ†âÌÜ†Î¶¨ ÏÇ≠Ï†ú Ïó¨Î∂Ä (default: false)
#   - delete_user: Ïú†Ï†Ä ÏÇ≠Ï†ú Ïó¨Î∂Ä (default: false)
# ============================================

# --- Phase 0: Variable Validation ---
- name: 'Phase 0: Validate Variables'
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    target_node: '{{ target_node | default("") }}'
    server_host: '{{ server_host | default("") }}'
  tasks:
    - name: 'Assert target_node is provided'
      ansible.builtin.assert:
        that:
          - target_node | length > 0
        fail_msg: |
          ‚ùå Required variable 'target_node' not provided!
          Usage: ansible-playbook teardown-node.yml -e "target_node=p-home-bucheon-node-ethereum-testnet"
        success_msg: '‚úÖ Target Node: {{ target_node }}'

    - name: 'Assert server_host is provided'
      ansible.builtin.assert:
        that:
          - server_host | length > 0
        fail_msg: |
          ‚ùå Required variable 'server_host' not provided!
          Usage: -e "server_host=p-home-bucheon-server-root"
        success_msg: '‚úÖ Server Host: {{ server_host }}'

    - name: 'Display Node host variables'
      ansible.builtin.debug:
        msg:
          - 'Target Node: {{ target_node }}'
          - 'Server Host: {{ server_host }}'
          - 'Network: {{ hostvars[target_node]["network"] }}'
          - 'Data Dir: {{ hostvars[target_node]["eth_data_dir"] }}'

# --- Phase 1: Node Ïú†Ï†ÄÎ°ú Workspace ÌôïÏù∏ ---
- name: 'Phase 1: Cleanup Node Workspace (as Node user)'
  hosts: '{{ target_node }}'
  gather_facts: true
  tags:
    - phase1
    - cleanup
  vars:
    # Ìò∏Ïä§Ìä∏ Î≥ÄÏàòÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
    node_network: '{{ network }}'
    node_data_dir: '{{ eth_data_dir }}'
    network_type: "{{ 'testnet' if node_network in ['hoodi', 'holesky', 'sepolia'] else 'mainnet' }}"
    node_user: "{{ 'testnet-node' if network_type == 'testnet' else 'ethereum-node' }}"
    el_service: 'el_{{ node_network }}'
    cl_service: 'cl_{{ node_network }}'
    mevboost_service: 'mevboost_{{ node_network }}'
  tasks:
    - name: '1.0 | ‚ö†Ô∏è Í≤ΩÍ≥†: Node Teardown ÏãúÏûë'
      ansible.builtin.debug:
        msg:
          - '=========================================='
          - '‚ö†Ô∏è  NODE TEARDOWN IN PROGRESS'
          - '=========================================='
          - 'Host: {{ inventory_hostname }}'
          - 'Network: {{ node_network }} ({{ network_type }})'
          - 'Node User: {{ node_user }}'
          - 'Data Dir: {{ node_data_dir }}'
          - '=========================================='
          - 'Services to remove:'
          - '  - {{ el_service }}'
          - '  - {{ cl_service }}'
          - '  - {{ mevboost_service }}'
          - '=========================================='

    - name: '1.1 | Get workspace directory'
      ansible.builtin.set_fact:
        workspace_dir: '{{ ansible_facts.user_dir }}/workspace'

    - name: '1.2 | Check if workspace exists'
      ansible.builtin.stat:
        path: '{{ workspace_dir }}'
      register: workspace_stat

    - name: '1.3 | List workspace contents (for logging)'
      ansible.builtin.find:
        paths: '{{ workspace_dir }}'
        file_type: any
      register: workspace_contents
      when: workspace_stat.stat.exists

    - name: '1.4 | üìù Phase 1 ÏôÑÎ£å Î©îÏãúÏßÄ'
      ansible.builtin.debug:
        msg:
          - '‚úÖ Phase 1 Complete: Workspace checked'
          - 'Workspace exists: {{ workspace_stat.stat.exists }}'
          - 'Items in workspace: {{ workspace_contents.files | default([]) | length }}'

# --- Phase 2: ÏÑúÎ≤Ñ(Root)Î°ú ÏÑúÎπÑÏä§/Îç∞Ïù¥ÌÑ∞/Ïú†Ï†Ä ÏÇ≠Ï†ú ---
- name: 'Phase 2: Remove Node Services, Data, and User (as root on server)'
  hosts: '{{ server_host }}'
  gather_facts: false
  become: true
  tags:
    - phase2
    - remove
  vars_files:
    - vars/secrets.yml
  vars:
    delete_data: '{{ delete_data | default(false) | bool }}'
    delete_user: '{{ delete_user | default(false) | bool }}'
    # Node Ìò∏Ïä§Ìä∏ Î≥ÄÏàòÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
    node_network: '{{ hostvars[target_node]["network"] }}'
    node_data_dir: '{{ hostvars[target_node]["eth_data_dir"] }}'
    network_type: "{{ 'testnet' if node_network in ['hoodi', 'holesky', 'sepolia'] else 'mainnet' }}"
    node_user: "{{ 'testnet-node' if network_type == 'testnet' else 'ethereum-node' }}"
    el_service: 'el_{{ node_network }}'
    cl_service: 'cl_{{ node_network }}'
    mevboost_service: 'mevboost_{{ node_network }}'
  tasks:
    # --- 2.1 MEV-Boost ÏÑúÎπÑÏä§ Ï†ïÎ¶¨ ---
    - name: '2.0 | Check if MEV-Boost service exists'
      ansible.builtin.stat:
        path: '/etc/systemd/system/{{ mevboost_service }}.service'
      register: mevboost_service_stat

    - name: '2.1 | Stop and disable MEV-Boost service'
      ansible.builtin.systemd_service:
        name: '{{ mevboost_service }}'
        state: stopped
        enabled: false
      when: mevboost_service_stat.stat.exists
      ignore_errors: true

    - name: '2.2 | Remove MEV-Boost service file'
      ansible.builtin.file:
        path: '/etc/systemd/system/{{ mevboost_service }}.service'
        state: absent
      when: mevboost_service_stat.stat.exists

    # --- 2.2 CL ÏÑúÎπÑÏä§ Ï†ïÎ¶¨ ---
    - name: '2.3 | Check if CL service exists'
      ansible.builtin.stat:
        path: '/etc/systemd/system/{{ cl_service }}.service'
      register: cl_service_stat

    - name: '2.4 | Stop and disable CL service'
      ansible.builtin.systemd_service:
        name: '{{ cl_service }}'
        state: stopped
        enabled: false
      when: cl_service_stat.stat.exists
      ignore_errors: true

    - name: '2.5 | Remove CL service file'
      ansible.builtin.file:
        path: '/etc/systemd/system/{{ cl_service }}.service'
        state: absent
      when: cl_service_stat.stat.exists

    # --- 2.3 EL ÏÑúÎπÑÏä§ Ï†ïÎ¶¨ ---
    - name: '2.6 | Check if EL service exists'
      ansible.builtin.stat:
        path: '/etc/systemd/system/{{ el_service }}.service'
      register: el_service_stat

    - name: '2.7 | Stop and disable EL service'
      ansible.builtin.systemd_service:
        name: '{{ el_service }}'
        state: stopped
        enabled: false
      when: el_service_stat.stat.exists
      ignore_errors: true

    - name: '2.8 | Remove EL service file'
      ansible.builtin.file:
        path: '/etc/systemd/system/{{ el_service }}.service'
        state: absent
      when: el_service_stat.stat.exists

    - name: '2.9 | Reload systemd daemon'
      ansible.builtin.systemd_service:
        daemon_reload: true

    # --- 2.4 Îç∞Ïù¥ÌÑ∞ ÎîîÎ†âÌÜ†Î¶¨ ÏÇ≠Ï†ú ---
    - name: '2.10 | Check if EL data directory exists'
      ansible.builtin.stat:
        path: '{{ node_data_dir }}/el'
      register: el_data_stat
      when: delete_data | bool

    - name: '2.11 | Check if CL data directory exists'
      ansible.builtin.stat:
        path: '{{ node_data_dir }}/cl'
      register: cl_data_stat
      when: delete_data | bool

    - name: '2.12 | ‚ö†Ô∏è Remove EL data directory'
      ansible.builtin.file:
        path: '{{ node_data_dir }}/el'
        state: absent
      when:
        - delete_data | bool
        - el_data_stat.stat.exists | default(false)

    - name: '2.13 | ‚ö†Ô∏è Remove CL data directory'
      ansible.builtin.file:
        path: '{{ node_data_dir }}/cl'
        state: absent
      when:
        - delete_data | bool
        - cl_data_stat.stat.exists | default(false)

    - name: '2.13a | Skip data deletion message'
      ansible.builtin.debug:
        msg: '‚è≠Ô∏è Skipping data deletion (delete_data={{ delete_data }})'
      when: not (delete_data | bool)

    # --- 2.5 Ïú†Ï†Ä ÏÇ≠Ï†ú ---
    - name: '2.14 | Check if Node user exists'
      ansible.builtin.getent:
        database: passwd
        key: '{{ node_user }}'
      register: node_user_check
      failed_when: false
      when: delete_user | bool

    - name: '2.14a | Kill all processes owned by Node user'
      ansible.builtin.command:
        cmd: 'pkill -9 -u {{ node_user }}'
      register: pkill_result
      failed_when: false
      changed_when: pkill_result.rc == 0
      when:
        - delete_user | bool
        - node_user_check.ansible_facts.getent_passwd[node_user] is defined

    - name: '2.14b | Wait for processes to terminate'
      ansible.builtin.pause:
        seconds: 2
      when:
        - delete_user | bool
        - pkill_result.rc | default(1) == 0

    - name: '2.15 | ‚ö†Ô∏è Remove Node user and home directory'
      ansible.builtin.user:
        name: '{{ node_user }}'
        state: absent
        remove: true
      when:
        - delete_user | bool
        - node_user_check.ansible_facts.getent_passwd[node_user] is defined

    - name: '2.15a | Skip user deletion message'
      ansible.builtin.debug:
        msg: '‚è≠Ô∏è Skipping user deletion (delete_user={{ delete_user }})'
      when: not (delete_user | bool)

    # --- ÏôÑÎ£å ---
    - name: '2.16 | üìù Teardown ÏôÑÎ£å Î©îÏãúÏßÄ'
      ansible.builtin.debug:
        msg:
          - '=========================================='
          - '‚úÖ NODE TEARDOWN COMPLETE'
          - '=========================================='
          - 'Host: {{ inventory_hostname }}'
          - 'Services removed:'
          - '  - {{ el_service }}: {{ "removed" if el_service_stat.stat.exists else "not found" }}'
          - '  - {{ cl_service }}: {{ "removed" if cl_service_stat.stat.exists else "not found" }}'
          - '  - {{ mevboost_service }}: {{ "removed" if mevboost_service_stat.stat.exists else "not found" }}'
          - ''
          - 'Data ({{ node_data_dir }}/el, cl): {{ "removed" if delete_data else "kept" }}'
          - 'User ({{ node_user }}): {{ "removed" if delete_user else "kept" }}'
          - '=========================================='
          - ''
          - 'üìã NEXT STEPS:'
          - '1. Remove entry from inventory/nodes.yml'
          - '=========================================='

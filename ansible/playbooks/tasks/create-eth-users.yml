# ============================================
# Ethereum Service User Creation Task
# ============================================
# 이 태스크는 enabled_networks 루프에서 호출됩니다.
# 변수: network_item (mainnet 또는 testnet)
# ============================================
---
- name: 'Load {{ network_item }} network variables'
  ansible.builtin.include_vars:
    file: 'vars/{{ network_item }}.yml'

- name: 'Debug | Creating users for {{ network_item }}'
  ansible.builtin.debug:
    msg: 'Creating {{ eth_node_user }} and {{ eth_vc_user }} for {{ network_item }}'

- name: "{{ network_item }} | Create '{{ eth_node_user }}' service user (for EL/CL clients)"
  ansible.builtin.user:
    name: '{{ eth_node_user }}'
    comment: '{{ eth_node_user_comment }}'
    system: no
    shell: /bin/bash
    create_home: true
    state: present
    groups: adm
    append: true

- name: "{{ network_item }} | Create '{{ eth_vc_user }}' service user (for Validator client)"
  ansible.builtin.user:
    name: '{{ eth_vc_user }}'
    comment: '{{ eth_vc_user_comment }}'
    system: no
    shell: /bin/bash
    create_home: true
    state: present
    groups: adm
    append: true

- name: '{{ network_item }} | Set authorized key for {{ eth_node_user }} and {{ eth_vc_user }}'
  loop:
    - '{{ eth_node_user }}'
    - '{{ eth_vc_user }}'
  loop_control:
    loop_var: eth_user
  ansible.posix.authorized_key:
    user: '{{ eth_user }}'
    state: present
    key: '{{ admin_user_ssh_key }}'
    exclusive: true

- name: '{{ network_item }} | Grant NOPASSWD sudo access to service users'
  loop:
    - '{{ eth_node_user }}'
    - '{{ eth_vc_user }}'
  loop_control:
    loop_var: eth_user
  ansible.builtin.lineinfile:
    path: '/etc/sudoers.d/99-{{ eth_user }}'
    line: '{{ eth_user }} ALL=(ALL) NOPASSWD: ALL'
    state: present
    create: true
    mode: '0440'
    validate: /usr/sbin/visudo -c -f %s

- name: '{{ network_item }} | Create data directories for Ethereum nodes'
  ansible.builtin.file:
    path: '{{ item.path }}'
    state: directory
    owner: '{{ item.owner }}'
    group: '{{ item.group }}'
    mode: '{{ item.mode }}'
  loop:
    - { path: '{{ eth_base_dir }}', owner: root, group: root, mode: '0755' }
    - {
        path: '{{ eth_el_dir }}',
        owner: '{{ eth_node_user }}',
        group: '{{ eth_node_user }}',
        mode: '0750',
      }
    - {
        path: '{{ eth_cl_dir }}',
        owner: '{{ eth_node_user }}',
        group: '{{ eth_node_user }}',
        mode: '0750',
      }
    - {
        path: '{{ eth_vc_dir }}',
        owner: '{{ eth_vc_user }}',
        group: '{{ eth_vc_user }}',
        mode: '0750',
      }

- name: '{{ network_item }} | Add service users to docker group (if docker installed)'
  loop:
    - '{{ eth_node_user }}'
    - '{{ eth_vc_user }}'
  loop_control:
    loop_var: eth_user
  ansible.builtin.user:
    name: '{{ eth_user }}'
    groups: docker
    append: true
  ignore_errors: true # docker 그룹이 없을 수 있음

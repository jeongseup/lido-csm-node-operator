---
# tasks/install_cl.yml

# --- 1. Lighthouse 바이너리 다운로드 및 설치 ---
- name: 1.1 | Find latest Lighthouse release URL
  ansible.builtin.uri:
    url: 'https://api.github.com/repos/sigp/lighthouse/releases/tags/v{{ cl_version }}'
    return_content: true
  register: lighthouse_release_info

- name: 1.2 | Set lighthouse_binaries_url fact
  ansible.builtin.set_fact:
    lighthouse_version_dir: '{{ ansible_facts.user_dir }}/workspace/bin/lighthouse-{{ cl_version }}'
    lighthouse_binaries_url: "{{
      lighthouse_release_info.json.assets |
      selectattr('name', 'contains', 'x86_64-unknown-linux-gnu.tar.gz') |
      map(attribute='browser_download_url') |
      first }}"

- name: 1.3 | Debug Show Lighthouse download URL
  ansible.builtin.debug:
    msg: 'Downloading Lighthouse from: {{ lighthouse_binaries_url }}'

- name: 1.4 | Ensure Lighthouse bin directory exists
  ansible.builtin.file:
    path: '{{ ansible_facts.user_dir }}/workspace/bin'
    state: directory
    mode: '0755'

- name: 1.5 | Ensure Lighthouse version directory exists
  ansible.builtin.file:
    path: '{{ lighthouse_version_dir }}'
    state: directory
    mode: '0755'

- name: 1.6 | Download and extract Lighthouse
  ansible.builtin.unarchive:
    src: '{{ lighthouse_binaries_url }}'
    dest: '{{ lighthouse_version_dir }}'
    remote_src: true
    mode: '0755'
    creates: '{{ lighthouse_version_dir }}/lighthouse' # 멱등성

- name: 1.7 | Symlink Lighthouse current version
  ansible.builtin.file:
    src: '{{ lighthouse_version_dir }}'
    dest: '{{ ansible_facts.user_dir }}/workspace/bin/lighthouse'
    state: link
    force: true
  notify: Restart CL service

# --- 2. Systemd 서비스 설정 ---
- name: 2.1 | Create Lighthouse systemd service file for CL
  ansible.builtin.template:
    src: '{{ cl_template_source }}'
    dest: '/etc/systemd/system/{{ service_name }}.service'
    mode: '0644'
  notify:
    - Reload systemd
    - Restart CL service
  become: true

- name: Create manage script file for the service
  ansible.builtin.template:
    src: '{{ cmd_template_source }}'
    dest: '{{ ansible_facts.user_dir }}/workspace/cmd/{{ service_name }}.sh'
    mode: '0755'

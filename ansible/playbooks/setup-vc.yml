---
- name: Playbook to set up Lido CSM Validator Client
  hosts: ethereum_vcs
  vars:
    # workspace configuration
    custom_prompt_name: '{{ inventory_hostname }}'
    user_workspace_base_dir: '~/workspace'
    user_workspace_subdirs:
      - cmd
      - config
      - env
      - lib # workspace lib directory
      - logs
      - bin
      - bin/lighthouse
      - validator_data
      - validator_keys
    # network_type ê°ì§€: hoodi, holesky, sepolia â†’ testnet, ê·¸ ì™¸ â†’ mainnet
    network_type: "{{ 'testnet' if network in ['hoodi', 'holesky', 'sepolia'] else 'mainnet' }}"
  pre_tasks:
    - name: Load network-specific variables (mainnet/testnet)
      ansible.builtin.include_vars:
        file: 'vars/{{ network_type }}.yml'

    # Set remote_user dynamically after loading network-specific vars
    - name: Set remote user for VC operations
      ansible.builtin.set_fact:
        ansible_user: '{{ eth_vc_user }}'

    - name: Display VC configuration
      ansible.builtin.debug:
        msg:
          - 'network: {{ network }}'
          - 'network_type: {{ network_type }}'
          - 'eth_vc_user: {{ eth_vc_user }}'
          - 'vc_data_dir: {{ eth_vc_dir }}'
          - 'vc_metrics_port: {{ vc_metrics_port }}'
  tasks:
    - name: ğŸ—‚ï¸ Create workspace directories
      ansible.builtin.file:
        path: '{{ user_workspace_base_dir }}/{{ item }}'
        state: directory
        mode: '0755'
      loop: '{{ user_workspace_subdirs }}'

    - name: Set custom shell prompt in .profile
      ansible.builtin.lineinfile:
        path: '~/.profile'
        # ê¸°ì¡´ PS1 ì„¤ì •ì„ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜, ì´ ë¼ì¸ì— ê³ ìœ  ë§ˆì»¤ë¥¼ ì¶”ê°€í•˜ì—¬ idempotentí•˜ê²Œ ê´€ë¦¬
        regexp: '^export PS1=.*# ANSIBLE_PROMPT_MARKER$' # ê¸°ì¡´ Ansible ê´€ë¦¬ í”„ë¡¬í”„íŠ¸ ë¼ì¸ ë§¤ì¹­
        line: 'export PS1="\[\033[01;32m\]{{ custom_prompt_name }}\[\033[00m\]:\[\033[01;34m\]\\w\[\033[00m\]\\$ " # ANSIBLE_PROMPT_MARKER'
        state: present
        create: true
        mode: '0644'
        insertafter: EOF # íŒŒì¼ ëì— ì¶”ê°€ (regexpë¡œ ê¸°ì¡´ ë¼ì¸ ëª» ì°¾ì„ ê²½ìš°)
        backup: true # .bashrc íŒŒì¼ ë³€ê²½ ì „ ë°±ì—…

    - name: Ensure all .sh scripts and sourced by .profile
      ansible.builtin.blockinfile:
        path: '~/.profile'
        create: true
        mode: '0644'
        marker: '# {mark} ANSIBLE MANAGED BLOCK FOR WORKSPACE ENV SCRIPTS' # ê³ ìœ í•œ ë§ˆì»¤ ì£¼ì„
        block: |
          if [ -d "{{ user_workspace_base_dir }}/env" ]; then
            for env_file_to_source in "{{ user_workspace_base_dir }}/env"/*.env; do
              if [ -f "$env_file_to_source" ] && [ -r "$env_file_to_source" ]; then
                . "$env_file_to_source"  # ê° .env íŒŒì¼ì„ source
              fi
            done
            unset env_file_to_source
          fi

    # --- 2. Lighthouse ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜ ---
    - name: Find latest Lighthouse release URL
      ansible.builtin.uri:
        url: 'https://api.github.com/repos/sigp/lighthouse/releases/latest'
        return_content: true
      register: lighthouse_release_info

    - name: Set binaries_url fact (linux-x64.zip)
      ansible.builtin.set_fact:
        vc_binary_url: "{{
          lighthouse_release_info.json.assets |
          selectattr('name', 'contains', 'x86_64-unknown-linux-gnu.tar.gz') |
          map(attribute='browser_download_url') |
          first }}"

    - name: Set version fact
      ansible.builtin.set_fact:
        vc_version: '{{ lighthouse_release_info.json.tag_name }}'

    - name: Debug Show Lighthouse download URL
      ansible.builtin.debug:
        msg: 'Downloading Lighthouse from: {{ vc_binary_url }} (for version {{ vc_version }})'

    - name: Download and extract Lighthouse
      ansible.builtin.unarchive:
        src: '{{ vc_binary_url }}'
        dest: '/home/{{ eth_vc_user }}/workspace/bin/lighthouse'
        remote_src: true
        mode: '0755'
        creates: '/home/{{ eth_vc_user }}/workspace/bin/lighthouse/lighthouse-{{ vc_version }}'

    - name: Create Validator Client systemd service file
      vars:
        # template source file
        vc_template_source: '../templates/vc.service.j2'
        # computed variables for template rendering
        vc_network: '{{ network }}'
        vc_graffiti: '{{ graffiti }}'
        vc_user: '{{ eth_vc_user }}'
        vc_workspace_lib_dir: '/home/{{ eth_vc_user }}/workspace/lib'
        vc_bin_dir: '/home/{{ eth_vc_user }}/workspace/bin/lighthouse'
        vc_data_dir: '{{ eth_vc_dir }}'
        vc_metrics_port_value: '{{ vc_metrics_port }}'
        vc_beacon_node_url: '{{ beacon_node_url }}'
        vc_fee_recipient_address: '{{ fee_recipient_address }}'
        service_name: 'vc_{{ network }}'
      ansible.builtin.template:
        src: '{{ vc_template_source }}'
        dest: '/etc/systemd/system/vc_{{ network }}.service'
        mode: '0644'
      notify: Reload systemd
      become: true

    - name: Create manage script file for the service
      vars:
        # template source file
        cmd_template_source: '../templates/cmd.sh.j2'
        # template variables
        service_name: 'vc_{{ network }}'
      ansible.builtin.template:
        src: '{{ cmd_template_source }}'
        dest: '/home/{{ eth_vc_user }}/workspace/cmd/vc_{{ network }}.sh'
        mode: '0755'

    - name: Create import_new_keys.sh from template
      vars:
        # template source file
        import_keys_template_source: 'templates/import_new_keys.sh.j2'
        # template variables
        vc_lighthouse_bin: '/home/{{ eth_vc_user }}/workspace/bin/lighthouse/lighthouse'
      ansible.builtin.template:
        src: '{{ import_keys_template_source }}'
        dest: '/home/{{ eth_vc_user }}/workspace/cmd/import_new_keys.sh'
        mode: '0755'
      tags: import-keys

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd_service:
        daemon_reload: true
      become: true
